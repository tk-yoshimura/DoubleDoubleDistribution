using DoubleDouble;
using DoubleDoubleStatistic.DiscreteDistributions;
using Microsoft.VisualStudio.TestTools.UnitTesting;

namespace DoubleDoubleStatisticTest.DiscreteDistributions {
    [TestClass()]
    public class SkellamDistributionTests {
        readonly SkellamDistribution dist_mu1mu1 = new(mu1: 1, mu2: 1);
        readonly SkellamDistribution dist_mu2mu1 = new(mu1: 2, mu2: 1);
        readonly SkellamDistribution dist_mu1mu2 = new(mu1: 1, mu2: 2);
        readonly SkellamDistribution dist_mu1mu4 = new(mu1: 1, mu2: 4);
        readonly SkellamDistribution dist_mu1mu8 = new(mu1: 1, mu2: 8);
        readonly SkellamDistribution dist_mu2mu8 = new(mu1: 2, mu2: 8);
        readonly SkellamDistribution dist_mu4mu8 = new(mu1: 4, mu2: 8);
        readonly SkellamDistribution dist_mu8mu8 = new(mu1: 8, mu2: 8);

        SkellamDistribution[] Dists => [
            dist_mu1mu1 ,
            dist_mu2mu1 ,
            dist_mu1mu2 ,
            dist_mu1mu4 ,
            dist_mu1mu8 ,
            dist_mu2mu8 ,
            dist_mu4mu8 ,
            dist_mu8mu8 ,
        ];

        [TestMethod()]
        public void InfoTest() {
            foreach (SkellamDistribution dist in Dists) {
                Console.WriteLine(dist);
                Console.WriteLine($"Support={dist.Support}");
                Console.WriteLine($"Mu1={dist.Mu1}");
                Console.WriteLine($"Mu2={dist.Mu2}");
                Console.WriteLine($"Mean={dist.Mean}");
                Console.WriteLine($"Variance={dist.Variance}");
                Console.WriteLine($"Skewness={dist.Skewness}");
                Console.WriteLine($"Kurtosis={dist.Kurtosis}");
                Console.WriteLine($"Entropy={dist.Entropy}");
                Console.WriteLine(dist.Formula);
            }
        }

        [TestMethod()]
        public void MeanTest() {
            Assert.AreEqual(0, (double)dist_mu1mu1.Mean, 1e-10);
            Assert.AreEqual(1.0, (double)dist_mu2mu1.Mean, 1e-10);
            Assert.AreEqual(-1.0, (double)dist_mu1mu2.Mean, 1e-10);
            Assert.AreEqual(-7, (double)dist_mu1mu8.Mean, 1e-10);
            Assert.AreEqual(-6.0, (double)dist_mu2mu8.Mean, 1e-10);
            Assert.AreEqual(-4.0, (double)dist_mu4mu8.Mean, 1e-10);
            Assert.AreEqual(0, (double)dist_mu8mu8.Mean, 1e-10);
        }

        [TestMethod()]
        public void VarianceTest() {
            Assert.AreEqual(2, (double)dist_mu1mu1.Variance, 1e-10);
            Assert.AreEqual(3.0, (double)dist_mu2mu1.Variance, 1e-10);
            Assert.AreEqual(3.0, (double)dist_mu1mu2.Variance, 1e-10);
            Assert.AreEqual(9.0, (double)dist_mu1mu8.Variance, 1e-10);
            Assert.AreEqual(10.0, (double)dist_mu2mu8.Variance, 1e-10);
            Assert.AreEqual(12.0, (double)dist_mu4mu8.Variance, 1e-10);
            Assert.AreEqual(16.0, (double)dist_mu8mu8.Variance, 1e-10);
        }

        [TestMethod()]
        public void SkewnessTest() {
            Assert.AreEqual(0, (double)dist_mu1mu1.Skewness, 1e-10);
            Assert.AreEqual(0.19245008972987526, (double)dist_mu2mu1.Skewness, 1e-10);
            Assert.AreEqual(-0.19245008972987526, (double)dist_mu1mu2.Skewness, 1e-10);
            Assert.AreEqual(-0.25925925925925924, (double)dist_mu1mu8.Skewness, 1e-10);
            Assert.AreEqual(-0.18973665961010278, (double)dist_mu2mu8.Skewness, 1e-10);
            Assert.AreEqual(-0.09622504486493763, (double)dist_mu4mu8.Skewness, 1e-10);
            Assert.AreEqual(0, (double)dist_mu8mu8.Skewness, 1e-10);
        }

        [TestMethod()]
        public void KurtosisTest() {
            Assert.AreEqual(0.5, (double)dist_mu1mu1.Kurtosis, 1e-10);
            Assert.AreEqual(0.3333333333333333, (double)dist_mu2mu1.Kurtosis, 1e-10);
            Assert.AreEqual(0.3333333333333333, (double)dist_mu1mu2.Kurtosis, 1e-10);
            Assert.AreEqual(0.1111111111111111, (double)dist_mu1mu8.Kurtosis, 1e-10);
            Assert.AreEqual(0.1, (double)dist_mu2mu8.Kurtosis, 1e-10);
            Assert.AreEqual(0.08333333333333333, (double)dist_mu4mu8.Kurtosis, 1e-10);
            Assert.AreEqual(0.0625, (double)dist_mu8mu8.Kurtosis, 1e-10);
        }

        [TestMethod()]
        public void EntropyTest() {
            Assert.AreEqual(1.761181328663819, (double)dist_mu1mu1.Entropy, 1e-10);
            Assert.AreEqual(1.9639542903980667, (double)dist_mu2mu1.Entropy, 1e-10);
            Assert.AreEqual(1.9639542903980667, (double)dist_mu1mu2.Entropy, 1e-10);
            Assert.AreEqual(2.511966950928609, (double)dist_mu1mu8.Entropy, 1e-10);
            Assert.AreEqual(2.567263773718327, (double)dist_mu2mu8.Entropy, 1e-10);
            Assert.AreEqual(2.6605544792413083, (double)dist_mu4mu8.Entropy, 1e-10);
            Assert.AreEqual(2.8051558007236457, (double)dist_mu8mu8.Entropy, 1e-10);
        }

        [TestMethod()]
        public void PMFTest() {
            foreach (SkellamDistribution dist in Dists) {
                Console.WriteLine(dist);
                for (int x = -24; x <= 24; x++) {
                    ddouble pdf = dist.PMF(x);

                    Console.WriteLine($"pmf({x})={pdf}");
                }
            }
        }

        [TestMethod()]
        public void RandomGenerateTest() {
            Random random = new(1234);

            foreach (SkellamDistribution dist in Dists) {
                int[] samples = dist.Sample(random, count: 1000000).ToArray();

                for (int i = -16; i <= 16; i++) {
                    Assert.AreEqual((double)dist.PMF(i), samples.Count(c => c == i) / (double)samples.Length, (double)dist.PMF(i) * 0.2 + 1e-5, $"{dist},{i}");
                }

                Assert.AreEqual((double)dist.Mean, samples.Average(), 0.05, $"{dist},mean");
            }
        }

        [TestMethod()]
        public void PMFExpectedTest() {
            ddouble[] expected_dist_mu1mu1 = [
                2.270198376317538691e-25,
                5.457542967461359033e-24,
                1.257505080892430385e-22,
                2.771968720930808602e-21,
                5.833709364763621399e-20,
                1.169513841673654878e-18,
                2.227910008544707783e-17,
                4.021933153797212322e-16,
                6.859565461540706469e-15,
                1.101552407000310585e-13,
                1.659188175962006688e-12,
                2.333878970416811745e-11,
                3.050634543301475521e-10,
                3.684100241665938404e-09,
                4.083016611265547030e-08,
                4.119857613682207870e-07,
                3.748702018426641296e-06,
                3.040160190878135078e-05,
                2.165599153798961074e-04,
                1.329761094188157975e-03,
                6.865365386320684653e-03,
                2.879122263947089810e-02,
                9.323903330473339024e-02,
                2.152692892489376786e-01,
                3.085083225536710549e-01,
                2.152692892489376786e-01,
                9.323903330473339024e-02,
                2.879122263947089810e-02,
                6.865365386320684653e-03,
                1.329761094188157975e-03,
                2.165599153798961074e-04,
                3.040160190878135078e-05,
                3.748702018426641296e-06,
                4.119857613682207870e-07,
                4.083016611265547030e-08,
                3.684100241665938404e-09,
                3.050634543301475521e-10,
                2.333878970416811745e-11,
                1.659188175962006688e-12,
                1.101552407000310585e-13,
                6.859565461540706469e-15,
                4.021933153797212322e-16,
                2.227910008544707783e-17,
                1.169513841673654878e-18,
                5.833709364763621399e-20,
                2.771968720930808602e-21,
                1.257505080892430385e-22,
                5.457542967461359033e-24,
                2.270198376317538691e-25,
            ];
            ddouble[] expected_dist_mu2mu1 = [
                8.691629416109904952e-26,
                2.092923094497606500e-24,
                4.831106376176721180e-23,
                1.067029248947872036e-21,
                2.250423635542883949e-20,
                4.522187856064729070e-19,
                8.637165399233851993e-18,
                1.563734147574221076e-16,
                2.675622381674641108e-15,
                4.312270493630913981e-14,
                6.521918188079861592e-13,
                9.216930873184423865e-12,
                1.211244849890135310e-10,
                1.471927681614529281e-09,
                1.643345346773784145e-08,
                1.672783900406075629e-07,
                1.538372417300942505e-06,
                1.264153611848876506e-05,
                9.156749766402316336e-05,
                5.746880582211163612e-04,
                3.056575286433628295e-03,
                1.337567726217674807e-02,
                4.624018235939748867e-02,
                1.192317192431485012e-01,
                2.117120839619435757e-01,
                2.384634384862970580e-01,
                1.849607294375899824e-01,
                1.070054180974139846e-01,
                4.890520458293806660e-02,
                1.839001786307572703e-02,
                5.860319850497482455e-03,
                1.618116623166560844e-03,
                3.938233388290413896e-04,
                8.564653570079101797e-05,
                1.682785635096355643e-05,
                3.014507891946555121e-06,
                4.961258905149989996e-07,
                7.550509771312676060e-08,
                1.068551075935003862e-08,
                1.413044795352977066e-09,
                1.753495884054293572e-10,
                2.049617621908482725e-11,
                2.264181086416756070e-12,
                2.370928826680464170e-13,
                2.359740214063017288e-14,
                2.237722523489528524e-15,
                2.026312879802351156e-16,
                1.755671141388738095e-17,
                1.458213441060295625e-18,
            ];
            ddouble[] expected_dist_mu1mu2 = [
                1.458213441060295625e-18,
                1.755671141388738095e-17,
                2.026312879802351156e-16,
                2.237722523489528524e-15,
                2.359740214063017288e-14,
                2.370928826680464170e-13,
                2.264181086416756070e-12,
                2.049617621908482725e-11,
                1.753495884054293572e-10,
                1.413044795352977066e-09,
                1.068551075935003862e-08,
                7.550509771312676060e-08,
                4.961258905149989996e-07,
                3.014507891946555121e-06,
                1.682785635096355643e-05,
                8.564653570079101797e-05,
                3.938233388290413896e-04,
                1.618116623166560844e-03,
                5.860319850497482455e-03,
                1.839001786307572703e-02,
                4.890520458293806660e-02,
                1.070054180974139846e-01,
                1.849607294375899824e-01,
                2.384634384862970580e-01,
                2.117120839619435757e-01,
                1.192317192431485012e-01,
                4.624018235939748867e-02,
                1.337567726217674807e-02,
                3.056575286433628295e-03,
                5.746880582211163612e-04,
                9.156749766402316336e-05,
                1.264153611848876506e-05,
                1.538372417300942505e-06,
                1.672783900406075629e-07,
                1.643345346773784145e-08,
                1.471927681614529281e-09,
                1.211244849890135310e-10,
                9.216930873184423865e-12,
                6.521918188079861592e-13,
                4.312270493630913981e-14,
                2.675622381674641108e-15,
                1.563734147574221076e-16,
                8.637165399233851993e-18,
                4.522187856064729070e-19,
                2.250423635542883949e-20,
                1.067029248947872036e-21,
                4.831106376176721180e-23,
                2.092923094497606500e-24,
                8.691629416109904952e-26,
            ];
            ddouble[] expected_dist_mu1mu4 = [
                3.585392404430799923e-12,
                2.165489787633591460e-11,
                1.254120108900392242e-10,
                6.951797843642994425e-10,
                3.681046870635080877e-09,
                1.857902929926647762e-08,
                8.917065088917454284e-08,
                4.059126863261020887e-07,
                1.747421579608225583e-06,
                7.091164490014427208e-06,
                2.702872223245615207e-05,
                9.637331893610015261e-05,
                3.199704671004394781e-04,
                9.840047310353443669e-04,
                2.786005627122307027e-03,
                7.211015250564603227e-03,
                1.692128572055093261e-02,
                3.564532525374301819e-02,
                6.660964062418800458e-02,
                1.088257922497178065e-01,
                1.526846504681942385e-01,
                1.798910985306237387e-01,
                1.730894865150163775e-01,
                1.315175178901641928e-01,
                7.615175110129514258e-02,
                3.287937947254104126e-02,
                1.081809290718852012e-02,
                2.810798414540995483e-03,
                5.964244158913836356e-04,
                1.062751877438649912e-04,
                1.626211929301464617e-05,
                2.175617996444278977e-06,
                2.581983294761798431e-07,
                2.750784015870899594e-08,
                2.656942011949829507e-09,
                2.346050098026621383e-10,
                1.907172603013753688e-11,
                1.436074360252920904e-12,
                1.006898367123908771e-13,
                6.604161569862100138e-15,
                4.068532911148443068e-16,
                2.362722800614442097e-17,
                1.297603752597565688e-18,
                6.759011484706745588e-20,
                3.347892625820417992e-21,
                1.580655826647442235e-22,
                7.128847465198727545e-24,
                3.077346075931459051e-25,
                1.273787263908875652e-26,
            ];
            ddouble[] expected_dist_mu1mu8 = [
                1.291028764787990466e-06,
                3.924106506712192855e-06,
                1.144318480239605790e-05,
                3.195927151992820122e-05,
                8.532348584011108499e-05,
                2.173036235402688867e-04,
                5.267615416381510448e-04,
                1.212376421628374610e-03,
                2.642145088665066432e-03,
                5.435837230033682861e-03,
                1.052246294239627886e-02,
                1.909378980294770822e-02,
                3.234271629758952993e-02,
                5.090079817175278964e-02,
                7.403143702335880649e-02,
                9.890189605066751488e-02,
                1.205185626849208796e-01,
                1.328812996912542843e-01,
                1.313359575654626243e-01,
                1.151121306355038509e-01,
                8.836207634287270019e-02,
                5.857005450087431758e-02,
                3.300902998068698524e-02,
                1.557351430778103167e-02,
                6.072818036058498861e-03,
                1.946689288472630260e-03,
                5.157660934482338191e-04,
                1.143946376970202599e-04,
                2.157277254464665193e-05,
                3.512943439804195517e-06,
                5.010069182032122579e-07,
                6.336274132311565644e-08,
                7.183466117675355189e-09,
                7.368765477140842879e-10,
                6.894714853107825831e-11,
                5.925632800412469963e-12,
                4.706484658176437627e-13,
                3.473140132509381454e-14,
                2.392531073927860378e-15,
                1.544957862629897439e-16,
                9.386784997875970065e-18,
                5.384032871217935565e-19,
                2.924113960068609403e-20,
                1.507846788680523631e-21,
                7.400632696950783208e-23,
                3.465031161296038263e-24,
                1.550840727863871335e-25,
                6.647694999440477226e-27,
                2.733859749071147194e-28,
            ];
            ddouble[] expected_dist_mu2mu8 = [
                6.503399512340718571e-07,
                2.001823804181166791e-06,
                5.917828424829371562e-06,
                1.677448411932606085e-05,
                4.551247791943825748e-05,
                1.179748158284271047e-04,
                2.915683070723739550e-04,
                6.855223948699480868e-04,
                1.529627165866733092e-03,
                3.230634930450952853e-03,
                6.439847286062221066e-03,
                1.207739148322162399e-02,
                2.123572298175068970e-02,
                3.487293234343147308e-02,
                5.325921271765593490e-02,
                7.529224898292778689e-02,
                9.801858328520773878e-02,
                1.168416455309396890e-01,
                1.267410856608741365e-01,
                1.242662256283906391e-01,
                1.093516624329627096e-01,
                8.574238762357898336e-02,
                5.949131096708278749e-02,
                3.630842464766544792e-02,
                1.941138082272888046e-02,
                9.077106161916360244e-03,
                3.718206935442672483e-03,
                1.339724806618420964e-03,
                4.271549313787602591e-04,
                1.213537359652251115e-04,
                3.094264786642434296e-05,
                7.131448091488029137e-06,
                1.495644886554072527e-06,
                2.872171363179316336e-07,
                5.079194328084552707e-08,
                8.314354978425860604e-09,
                1.265747724875848665e-09,
                1.799671572926884831e-10,
                2.399030061834394664e-11,
                3.008763241070282015e-12,
                3.561440775791954615e-13,
                3.990265510917807865e-14,
                4.242877287795630480e-15,
                4.291898797543658723e-16,
                4.139335753228640548e-17,
                3.814076107875293351e-18,
                3.363895998989722147e-19,
                2.844762724665153462e-20,
                2.310471640619744196e-21,
            ];
            ddouble[] expected_dist_mu4mu8 = [
                1.632790908350503937e-07,
                5.147852547182314317e-07,
                1.561647152732440563e-06,
                4.551922297373324987e-06,
                1.272961960697119890e-05,
                3.410001016611465636e-05,
                8.735233394800790492e-05,
                2.135927564660751346e-04,
                4.975607744644135796e-04,
                1.101917927161864428e-03,
                2.314876500660702132e-03,
                4.601992839737160945e-03,
                8.635676614903234349e-03,
                1.525451134222342679e-02,
                2.529279140300885048e-02,
                3.924324492487275134e-02,
                5.679504624198630780e-02,
                7.641666870442262449e-02,
                9.526210823736300237e-02,
                1.096549155302335571e-01,
                1.161653763250774657e-01,
                1.129101459276554420e-01,
                1.004239928854095687e-01,
                8.156107118518006460e-02,
                6.040713034085229416e-02,
                4.078053559259010863e-02,
                2.510599822135238524e-02,
                1.411376824095695280e-02,
                7.260336020317339871e-03,
                3.426716110319802562e-03,
                1.488470441208796045e-03,
                5.970052242533024044e-04,
                2.218556493827588251e-04,
                7.664696274389217379e-05,
                2.469999160450081022e-05,
                7.448491866320038543e-06,
                2.108319486060359525e-06,
                5.617667040694789250e-07,
                1.412888489172793946e-07,
                3.362786642950027045e-08,
                7.592174903326619915e-09,
                1.629583408096884020e-09,
                3.332227094574279777e-10,
                6.504060776923115375e-11,
                1.213991127678984360e-11,
                2.170525692640940408e-12,
                3.723256952124694876e-13,
                6.136718448617830514e-14,
                9.732192208471916155e-15,
            ];
            ddouble[] expected_dist_mu8mu8 = [
                9.902018612358784003e-09,
                3.261096681815901260e-08,
                1.036585482145659560e-07,
                3.176719744082153783e-07,
                9.375474810361314564e-07,
                2.661540676998543437e-06,
                7.258706588907673125e-06,
                1.899363050204080797e-05,
                4.762017140574438328e-05,
                1.142339733135296016e-04,
                2.618088713686123406e-04,
                5.723994982086012383e-04,
                1.191958055957589597e-03,
                2.360336582144985200e-03,
                4.437420856406944572e-03,
                7.907112652653662879e-03,
                1.333292259064231683e-02,
                2.124003524329598491e-02,
                3.191795342852631751e-02,
                4.517850031469070743e-02,
                6.015451612520800878e-02,
                7.525575837729470141e-02,
                8.837542551669357038e-02,
                9.734961475646805584e-02,
                1.005441273612520114e-01,
                9.734961475646805584e-02,
                8.837542551669357038e-02,
                7.525575837729470141e-02,
                6.015451612520800878e-02,
                4.517850031469070743e-02,
                3.191795342852631751e-02,
                2.124003524329598491e-02,
                1.333292259064231683e-02,
                7.907112652653662879e-03,
                4.437420856406944572e-03,
                2.360336582144985200e-03,
                1.191958055957589597e-03,
                5.723994982086012383e-04,
                2.618088713686123406e-04,
                1.142339733135296016e-04,
                4.762017140574438328e-05,
                1.899363050204080797e-05,
                7.258706588907673125e-06,
                2.661540676998543437e-06,
                9.375474810361314564e-07,
                3.176719744082153783e-07,
                1.036585482145659560e-07,
                3.261096681815901260e-08,
                9.902018612358784003e-09,
            ];

            foreach ((SkellamDistribution dist, ddouble[] expecteds) in new[]{
                (dist_mu1mu1, expected_dist_mu1mu1),
                (dist_mu2mu1, expected_dist_mu2mu1),
                (dist_mu1mu2, expected_dist_mu1mu2),
                (dist_mu1mu4 , expected_dist_mu1mu4 ),
                (dist_mu1mu8 , expected_dist_mu1mu8 ),
                (dist_mu2mu8, expected_dist_mu2mu8),
                (dist_mu4mu8, expected_dist_mu4mu8),
                (dist_mu8mu8, expected_dist_mu8mu8)
            }) {
                for ((int x, int i) = (-24, 0); i < expecteds.Length; x++, i++) {
                    ddouble expected = expecteds[i];
                    ddouble actual = dist.PMF(x);

                    Console.WriteLine($"{dist} pmf({x})");
                    Console.WriteLine(expected);
                    Console.WriteLine(actual);

                    Assert.IsTrue(ddouble.Abs(expected - actual) / expected < 1e-10, $"{dist} pmf({x})\n{expected}\n{actual}");
                }
            }
        }
    }
}